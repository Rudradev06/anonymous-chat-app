<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Anonymous Chat</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <h1>Anonymous Chat</h1>
      <div id="chatArea" class="chat-area"></div>
      <form id="chatForm" class="chat-form">
        <input
          type="text"
          id="messageInput"
          placeholder="Type a message..."
          required
        />
        <button type="submit">Send</button>
      </form>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const chatForm = document.getElementById("chatForm");
      const messageInput = document.getElementById("messageInput");
      const chatArea = document.getElementById("chatArea");

      // Debounce function to limit typing events
      function debounce(func, wait) {
        let timeout;
        return function (...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      }

      // Append message to chat area
      function appendMessage(content, isSystem = false, username = null) {
        const messageDiv = document.createElement("div");
        messageDiv.className = isSystem ? "system-message" : "message";
        if (!isSystem) {
          const timestamp = new Date().toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
          });
          messageDiv.innerHTML = `
          <div class="message-content">${content}</div>
          <div class="timestamp">${timestamp}</div>
        `;
        } else {
          messageDiv.textContent = content;
          if (content.includes("is typing...")) {
            messageDiv.classList.add("typing-indicator");
            messageDiv.dataset.username = username; // Store username for replacement
          }
        }
        chatArea.appendChild(messageDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
      }

      // Remove typing indicator for a specific user
      function removeTypingIndicator(username) {
        const indicators = chatArea.querySelectorAll(
          `.typing-indicator[data-username="${username}"]`
        );
        indicators.forEach((indicator) => indicator.remove());
      }

      // Handle form submission
      chatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const msg = messageInput.value.trim();
        if (msg) {
          socket.emit("chat message", msg);
          messageInput.value = "";
          // Clear typing indicator when message is sent
          socket.emit("stop typing");
        }
      });

      // Handle typing with debounce
      const emitTyping = debounce(() => {
        socket.emit("typing");
      }, 500);

      messageInput.addEventListener("input", () => {
        emitTyping();
      });

      // Socket.IO events
      socket.on("chat message", (data) => {
        appendMessage(`${data.username}: ${data.message}`);
      });

      socket.on("user connected", (msg) => {
        appendMessage(msg, true);
      });

      socket.on("user disconnected", (msg) => {
        appendMessage(msg, true);
      });

      socket.on("typing", (username) => {
        // Remove existing typing indicator for this user
        removeTypingIndicator(username);
        // Add new typing indicator
        appendMessage(`${username} is typing...`, true, username);
        // Remove after 2 seconds
        setTimeout(() => {
          removeTypingIndicator(username);
        }, 2000);
      });

      socket.on("stop typing", (username) => {
        removeTypingIndicator(username);
      });
    </script>
  </body>
</html>
